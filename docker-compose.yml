version: '3.8'

services:
  # MongoDB Database
  mongo:
    image: mongo:7.0
    container_name: smartnest-mongo
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_DATABASE: smartnest
    volumes:
      - mongo_data:/data/db
      - ./mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    networks:
      - smartnest-network

  # Spring Boot Backend
  backend-java:
    build:
      context: ./backend-java
      dockerfile: Dockerfile
    container_name: smartnest-backend
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      SPRING_DATA_MONGODB_HOST: mongo
      SPRING_DATA_MONGODB_PORT: 27017
      SPRING_DATA_MONGODB_DATABASE: smartnest
    depends_on:
      - mongo
    networks:
      - smartnest-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/auth/login"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Node.js IoT Gateway
  gateway-node:
    build:
      context: ./gateway-node
      dockerfile: Dockerfile
    container_name: smartnest-gateway
    restart: unless-stopped
    ports:
      - "4000:4000"
    environment:
      NODE_ENV: production
    networks:
      - smartnest-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:4000/status"]
      interval: 30s
      timeout: 10s
      retries: 3

  # React Frontend
  frontend-react:
    build:
      context: ./frontend-react
      dockerfile: Dockerfile
    container_name: smartnest-frontend
    restart: unless-stopped
    ports:
      - "5173:5173"
    depends_on:
      - backend-java
    networks:
      - smartnest-network

volumes:
  mongo_data:
    driver: local

networks:
  smartnest-network:
    driver: bridge

